<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã»ã‚ã»ã‚ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆã»ã‚ã‚¹ã‚¿ï¼‰</title>

    <!-- PWA manifest èª­ã¿è¾¼ã¿ï¼ˆGitHub Pagesç”¨ï¼‰ -->
    <link rel="manifest" href="manifest.webmanifest">

    <!-- iPhoneç”¨ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- faviconï¼ˆä»»æ„ï¼‰ -->
    <link rel="icon" type="image/png" href="icons/icon-192.png">

    <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼è‰²ãªã©ï¼‰ -->
    <meta name="theme-color" content="#FFF4C7">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FMFQS52W93"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FMFQS52W93');
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- canvas-confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'BIZ UDPGothic', Meiryo, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .stamp-card {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    padding: 16px;
    border-radius: 16px;          /* è§’ã®ä¸¸ã¿ã ã‘æ®‹ã™ï¼ˆä¸è¦ãªã‚‰æ¶ˆã—ã¦OKï¼‰ */
    background-color: transparent; /* èƒŒæ™¯è‰²ãªã—ã«ã™ã‚‹ */
    box-shadow: none;             /* â† å½±ã‚’æ¶ˆã™ãƒã‚¤ãƒ³ãƒˆ */
}


        .stamp-slot {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border-radius: 50%;
            background-color: #ffffff;
            border: 3px dashed #fbd38d;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .stamp-slot:hover {
            transform: scale(1.05);
        }

        .stamp-slot.is-reward .reward-icon {
            display: block;
        }
        
        .reward-icon {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #f6ad55;
            z-index: 5;
            pointer-events: none;
        }

        .stamp-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            z-index: 10;
        }
        
        .stamp-date {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: #6a4d0f;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 5px;
            border-radius: 8px;
            z-index: 15;
            white-space: nowrap;
        }

        .stock-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 9999px;
            border: none;
            background-color: rgba(0,0,0,0.5);
            color: #fff;
            font-size: 14px;
            line-height: 18px;
            text-align: center;
            cursor: pointer;
            z-index: 20;
        }

        .exchanged-slot-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 50%;
            background-color: #e5e7eb;
        }
        .exchanged-icon {
            font-size: 1.5rem;
            color: #16a34a;
        }
        .exchanged-date {
            font-size: 0.75rem;
            color: #4b5563;
            font-weight: 600;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.is-visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.is-visible .modal-content {
             transform: scale(1);
        }
        
        #celebration-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: rgba(255, 250, 230, 0.9);
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
        }
        #celebration-screen.is-visible {
            opacity: 1;
            visibility: visible;
        }
        #celebration-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .stamp-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .stamp-overlay.is-visible {
            opacity: 1;
        }
        .animated-stamp {
            position: absolute;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            transform: scale(2);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .animated-stamp.animate-in {
            transform: scale(1) translateY(-20px);
            opacity: 1;
        }
        .animated-stamp.animate-out {
            transform: scale(0.5);
            opacity: 0;
        }
    </style>
</head>
<body class="bg-amber-50">

  <div class="p-4 max-w-lg mx-auto">
    <!-- ãƒ­ã‚´ -->
    <div class="flex justify-center mb-4">
      <img
        src="homesta-logo.png"
        alt="ã»ã‚ã‚¹ã‚¿ ãƒ­ã‚´"
        class="w-40 md:w-56 max-w-full h-auto mx-auto"
      >
    </div>

    <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
    <div id="app"></div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆå³å¯„ã›ï¼‰ -->
  <div class="w-full mt-10 pb-6 flex flex-col items-end gap-3 pr-4">

    <!-- å•ã„åˆã‚ã›ãƒœã‚¿ãƒ³ -->
    <button id="contactButton"
      class="bg-yellow-200 border border-gray-300 shadow-md
             px-4 py-2 rounded-lg text-sm z-50 w-48 text-center">
      å•ã„åˆã‚ã›ã¯ã“ã¡ã‚‰
    </button>

    <!-- ç¤¾åãƒ­ã‚´ -->
    <div class="flex items-center gap-2 opacity-80">
      <img src="fukushi-logo.png"
           alt="ä¸€èˆ¬ç¤¾å›£æ³•äººç¦ç¥‰ã§ã¤ãªãŒã‚‹ä¼š ãƒ­ã‚´"
           class="w-8 h-8 rounded-full object-cover">
      <p class="text-xs text-gray-600 font-semibold">
        ä¸€èˆ¬ç¤¾å›£æ³•äººç¦ç¥‰ã§ã¤ãªãŒã‚‹ä¼š
      </p>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="feedbackForm"
    class="fixed bottom-32 right-4 bg-white border border-gray-300 rounded-lg shadow-xl
           p-4 w-72 z-50 hidden">

    <h3 class="text-lg mb-3 font-bold">ãŠå•ã„åˆã‚ã›</h3>

    <form id="feedbackSubmitForm">
      <label class="text-sm">ã‚¢ãƒ—ãƒªã‚’é¸æŠï¼ˆå¿…é ˆï¼‰</label>
      <select id="appName" required
        class="w-full border rounded px-2 py-1 mb-3 text-sm">
        <option value="" disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ã‚ã¨ãªã‚“ã‹ã„ï¼Ÿã‚¢ãƒ—ãƒª">ã‚ã¨ãªã‚“ã‹ã„ï¼Ÿã‚¢ãƒ—ãƒª</option>
        <option value="ãƒªãƒ•ãƒ¬ãƒŸãƒ¼">ãƒªãƒ•ãƒ¬ãƒŸãƒ¼</option>
        <option value="ã»ã‚ã‚¹ã‚¿">ã»ã‚ã‚¹ã‚¿</option>
        <option value="ã‚ã–ã›ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ãƒã‚¹ã‚¿ãƒ¼">ã‚ã–ã›ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ãƒã‚¹ã‚¿ãƒ¼</option>
      </select>

      <label class="text-sm">ç¨®åˆ¥</label>
      <select id="feedbackType"
        class="w-full border rounded px-2 py-1 mb-3 text-sm">
        <option>ãƒã‚°å ±å‘Š</option>
        <option>è¦æœ›</option>
        <option>è³ªå•</option>
        <option>ãã®ä»–</option>
      </select>

      <label class="text-sm">å†…å®¹</label>
      <textarea id="content"
        class="w-full border rounded px-2 py-1 mb-3 text-sm h-20"
        required></textarea>

      <label class="text-sm">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
      <input id="email" type="email"
        class="w-full border rounded px-2 py-1 mb-3 text-sm">

      <button type="submit"
        class="w-full bg-orange-300 py-2 rounded-lg text-sm font-bold mb-2">
        é€ä¿¡
      </button>

      <button type="button" id="closeFeedback"
        class="w-full bg-gray-200 py-2 rounded-lg text-sm">
        é–‰ã˜ã‚‹
      </button>
    </form>

    <div id="feedbackThanks" class="hidden text-center">
      <p class="mb-4">é€ä¿¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
      <button type="button" id="closeThanks"
        class="w-full bg-gray-200 py-2 rounded-lg text-sm">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

  <!-- ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="stamp-modal" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="text-xl font-bold text-center mb-4 text-gray-700">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãˆã‚‰ã‚“ã§ã­</h3>
      <div class="grid grid-cols-3 gap-4 mb-4">
        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ãƒ³ãƒ— -->
        <div id="default-stamp-1" class="p-2 bg-yellow-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-yellow-200 transition">
          <svg class="w-10 h-10 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
        </div>
        <div id="default-stamp-2" class="p-2 bg-blue-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-blue-200 transition">
          <svg class="w-10 h-10 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
        </div>
        <div id="default-stamp-3" class="p-2 bg-green-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-green-200 transition">
          <svg class="w-10 h-10 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a2 2 0 00-.8 1.4z"></path></svg>
        </div>
        
        <!-- ã‚¹ãƒˆãƒƒã‚¯ã•ã‚ŒãŸãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚¹ã‚¿ãƒ³ãƒ— -->
        <div id="stocked-stamp-0" class="relative p-2 bg-gray-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-gray-200 transition">
          <button class="stock-delete-btn hidden" type="button">Ã—</button>
          <span class="text-gray-400 text-lg"></span>
        </div>
        <div id="stocked-stamp-1" class="relative p-2 bg-gray-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-gray-200 transition">
          <button class="stock-delete-btn hidden" type="button">Ã—</button>
          <span class="text-gray-400 text-lg"></span>
        </div>
        <div id="stocked-stamp-2" class="relative p-2 bg-gray-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-gray-200 transition">
          <button class="stock-delete-btn hidden" type="button">Ã—</button>
          <span class="text-gray-400 text-lg"></span>
        </div>
      </div>
      <label for="image-upload" class="w-full text-center block bg-orange-400 text-white font-bold py-3 px-4 rounded-lg cursor-pointer hover:bg-orange-500 transition">
        ã—ã‚ƒã—ã‚“ã‹ã‚‰ãˆã‚‰ã¶
      </label>
      <input type="file" id="image-upload" class="hidden" accept="image/*">
      <button id="cancel-stamp" class="w-full text-center mt-3 text-gray-600 py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- ã”è¤’ç¾é”æˆãŠç¥ã„ç”»é¢ -->
  <div id="celebration-screen">
    <canvas id="celebration-canvas"></canvas>
    <div class="text-center p-4 relative z-10">
      <p class="text-4xl font-bold text-orange-500 mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">ã‚„ã£ãŸã­ï¼</p>
      <p id="celebration-message" class="text-xl font-semibold text-gray-700"></p>
      <button id="close-celebration" class="mt-8 bg-white text-orange-500 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-orange-50 transition">ã¨ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="stamp-overlay" class="stamp-overlay">
    <img id="animated-stamp-image" src="" alt="ã‚¹ã‚¿ãƒ³ãƒ—" class="animated-stamp">
  </div>

  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="delete-confirm-modal" class="modal-backdrop">
    <div class="modal-content text-center">
      <h3 id="delete-confirm-title" class="text-xl font-bold text-center mb-4 text-gray-700"></h3>
      <p class="text-gray-600 mb-6">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
      <div class="flex justify-center gap-4">
        <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="confirm-delete-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    const contactButton = document.getElementById("contactButton");
    const feedbackForm = document.getElementById("feedbackForm");
    const closeFeedback = document.getElementById("closeFeedback");
    const feedbackSubmitForm = document.getElementById("feedbackSubmitForm");
    const feedbackThanks = document.getElementById("feedbackThanks");
    const closeThanks = document.getElementById("closeThanks");

    contactButton.addEventListener("click", () => {
      feedbackForm.classList.remove("hidden");
    });

    closeFeedback.addEventListener("click", () => {
      feedbackForm.classList.add("hidden");
    });

    feedbackSubmitForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const appName = document.getElementById("appName").value;
      const feedbackType = document.getElementById("feedbackType").value;
      const content = document.getElementById("content").value;
      const email = document.getElementById("email").value;

      if (!appName) {
        alert("ã‚¢ãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const subject = encodeURIComponent(`[${appName}] å•ã„åˆã‚ã›: ${feedbackType}`);
      const body = encodeURIComponent(
        `ã‚¢ãƒ—ãƒªï¼š${appName}\nç¨®åˆ¥:${feedbackType}\n\nå†…å®¹:\n${content}\n\nãƒ¡ãƒ¼ãƒ«:${email || "æœªè¨˜å…¥"}`
      );

      window.location.href =
        `mailto:info.fukushi@allcare.co.jp?subject=${subject}&body=${body}`;

      feedbackSubmitForm.classList.add("hidden");
      feedbackThanks.classList.remove("hidden");
    });

    closeThanks.addEventListener("click", () => {
      feedbackForm.classList.add("hidden");
      feedbackSubmitForm.classList.remove("hidden");
      feedbackThanks.classList.add("hidden");
      feedbackSubmitForm.reset();
    });
  </script>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const app = document.getElementById('app');
    const stampModal = document.getElementById('stamp-modal');
    const celebrationScreen = document.getElementById('celebration-screen');
    const celebrationCanvas = document.getElementById('celebration-canvas');
    const stampOverlay = document.getElementById('stamp-overlay');
    const animatedStampImage = document.getElementById('animated-stamp-image');
    let confettiInstance = confetti.create(celebrationCanvas, { resize: true });

    let appData = {
        currentUserIndex: null,
        users: []
    };
    let deleteIndex = null;
    let deleteMode = null;   // 'user' / 'stamp'
    let isExchangeMode = false;
    let editBackup = null;
    
    const getCurrentState = () => {
        if (appData.currentUserIndex === null || !appData.users[appData.currentUserIndex]) {
            return null;
        }
        return appData.users[appData.currentUserIndex];
    };

    function saveAppData() {
        localStorage.setItem('ganbariCardAppData', JSON.stringify(appData));
    }

    function loadAppData() {
        const savedData = localStorage.getItem('ganbariCardAppData');
        if (savedData) {
            appData = JSON.parse(savedData);

            appData.users.forEach(user => {
                if (typeof user.cardBackground === 'undefined') {
                    user.cardBackground = '#fff9e6'; 
                }
                if (typeof user.exchanges === 'undefined') {
                    user.exchanges = [];
                }
                if (!Array.isArray(user.stockedStamps)) {
                    user.stockedStamps = [];
                }
                if (typeof user.memo === 'undefined') {
                    user.memo = '';
                }
                if (typeof user.comment === 'undefined') {
                    user.comment = '';
                }

                if (Array.isArray(user.stamps)) {
                    user.stamps.forEach(s => {
                        if (!s || typeof s.image !== 'string') return;
                        const trimmed = s.image.trim();
                        if (trimmed.startsWith('<img')) {
                            const m = trimmed.match(/src="([^"]+)"/);
                            if (m) {
                                s.image = m[1];
                            }
                        }
                    });
                }
            });
            return;
        }

        // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ç§»è¡Œ
        const oldSavedState = localStorage.getItem('ganbariCardState');
        if(oldSavedState){
            const oldState = JSON.parse(oldSavedState);
            if (oldState.name || (oldState.stamps && oldState.stamps.length > 0)) {
                oldState.goal = oldState.goal || '';
                oldState.cardBackground = '#fff9e6';
                oldState.exchanges = [];
                oldState.stockedStamps = oldState.stockedStamps || [];
                oldState.memo = '';
                oldState.comment = '';
                if (Array.isArray(oldState.stamps)) {
                    oldState.stamps.forEach(s => {
                        if (!s || typeof s.image !== 'string') return;
                        const trimmed = s.image.trim();
                        if (trimmed.startsWith('<img')) {
                            const m = trimmed.match(/src="([^"]+)"/);
                            if (m) {
                                s.image = m[1];
                            }
                        }
                    });
                }
                appData.users.push(oldState);
                appData.currentUserIndex = 0;
            }
            localStorage.removeItem('ganbariCardState');
            saveAppData();
        }
    }

    // ãƒ›ãƒ¼ãƒ ç”»é¢
    function renderHomeScreen() {
        isExchangeMode = false;
        appData.currentUserIndex = null;

        const users = appData.users || [];

        const userButtons = users.map((user, index) => {
            const name = user.name || `ã‚«ãƒ¼ãƒ‰ ${index + 1}`;
            const filledSlots = (user.stamps?.length || 0) + (user.exchanges?.length || 0);
            const total = user.stampCount || 0;
            const isComplete = total > 0 && filledSlots === total;
            const progressLabel = total > 0 ? `${filledSlots}/${total}` : '0/10';

            return `
                <div class="flex items-center mb-3">
                    <button
                        data-index="${index}"
                        class="user-select-btn w-full text-left p-4 bg-white rounded-lg shadow hover:bg-yellow-50 transition flex justify-between items-center">
                        <span class="text-lg font-bold text-gray-700">${name}</span>
                        <span class="text-sm font-semibold ${isComplete ? 'text-green-500' : 'text-gray-500'}">
                            ${isComplete ? 'ã‹ã‚“ã›ã„ï¼' : progressLabel}
                        </span>
                    </button>
                    <button
                        data-index="${index}"
                        class="delete-user-btn ml-2 p-3 bg-red-100 rounded-full hover:bg-red-200 transition">
                        <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                  d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                                  clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');

        const newCardButton = users.length < 5
            ? `
            <button
                id="add-new-card-btn"
                class="w-full mt-4 p-4 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition shadow-lg">
                ã‚ãŸã‚‰ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹
            </button>
            `
            : '';

        app.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h1 class="text-2xl font-bold text-center mb-1 text-yellow-600">
                    ã©ã®ã‚«ãƒ¼ãƒ‰ã‚’ã¤ã‹ã„ã¾ã™ã‹ï¼Ÿ
                </h1>
                <p class="text-center text-sm text-gray-500 mb-4">
                    ã‚«ãƒ¼ãƒ‰ã‚’ãˆã‚‰ã‚“ã§ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãŸã‚ã‚ˆã†
                </p>

                <div class="user-list mt-2">
                    ${userButtons || ''}
                </div>

                ${newCardButton}

                <div class="mt-6 text-center">
                  <a
                    href="homesta-help.html"
                    class="inline-flex items-center gap-1 text-sm text-blue-500 hover:text-blue-600 underline"
                  >
                    <span>ã¤ã‹ã„ã‹ãŸï¼ˆèª¬æ˜æ›¸ï¼‰</span>
                  </a>
                </div>
            </div>
        `;

        addHomeScreenListeners();
    }
    
    // è¨­å®šç”»é¢
    function renderSetup() {
        isExchangeMode = false;
        const state = getCurrentState();
        if (!state) return renderHomeScreen();

        const isEditMode = !state.isSetup;

        if (isEditMode) {
            editBackup = JSON.parse(JSON.stringify(state));
        } else {
            editBackup = null;
        }

        state.rewards = state.rewards.filter(r => r < state.stampCount);
        const lastIndex = state.stampCount - 1;
        if (!state.rewards.includes(lastIndex)) state.rewards.push(lastIndex);

        const minStampCount = isEditMode ? state.stampCount : 5;
        const primaryBtnLabel = isEditMode ? 'ã‚«ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹' : 'ã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹ï¼';
        const titleText = isEditMode ? 'ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã‚ˆã†' : 'ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚ã†';

        app.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h1 class="text-2xl font-bold text-center mb-1 text-yellow-600">${titleText}</h1>
                <p class="text-center text-gray-500 mb-6">ãªã¾ãˆã‚„ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‹ãšã‚’ãã‚ã¦ã­</p>

                <div class="mb-4">
                    <label for="name-input" class="block text-gray-700 font-bold mb-2">ãªã¾ãˆ</label>
                    <input
                        type="text"
                        id="name-input"
                        value="${state.name}"
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="ï¼ˆã‚Œã„ï¼‰ãŸã‚ã†">
                </div>

                <div class="mb-4">
                    <label for="goal-input" class="block text-gray-700 font-bold mb-2">ã‚‚ãã²ã‚‡ã†</label>
                    <input
                        type="text"
                        id="goal-input"
                        value="${state.goal || ''}"
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                        placeholder="ï¼ˆã‚Œã„ï¼‰æœï¼—æ™‚ã¾ã§ã«ãŠãã¾ã™">
                </div>

                <div class="mb-6">
                    <p class="block text-gray-700 font-bold mb-2">ã‚«ãƒ¼ãƒ‰ã® ã¯ã„ã‘ã„</p>
                    <div id="background-selector" class="flex gap-3 justify-center"></div>
                </div>

                <div class="mb-6">
                    <label for="stamp-count-slider" class="block text-gray-700 font-bold mb-2">
                        ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‹ãš: <span id="stamp-count-label">${state.stampCount}</span>
                    </label>
                    <input
                        type="range"
                        id="stamp-count-slider"
                        min="${minStampCount}"
                        max="30"
                        value="${state.stampCount}"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    ${
                        isEditMode
                            ? '<p class="mt-1 text-xs text-gray-500">â€» ã„ã¾ã‚ˆã‚Šå°‘ãªãã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“</p>'
                            : ''
                    }
                </div>

                <div class="mb-6">
                    <p class="block text-gray-700 font-bold mb-2">ã”ã»ã†ã³ã‚’ã„ã‚Œã‚‹</p>
                    <div id="reward-selector" class="grid grid-cols-5 gap-2"></div>
                </div>

                <button
                    id="create-card-btn"
                    class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition">
                    ${primaryBtnLabel}
                </button>

                ${
                    isEditMode
                        ? `
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-card-btn" class="text-sm text-gray-600 hover:underline">
                            ä¿®æ­£ã‚’ã—ãªã„ã§ã‚‚ã©ã‚‹
                        </button>
                        <button id="delete-card-btn" class="text-sm text-red-500 hover:underline">
                            ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‘ã™
                        </button>
                    </div>
                    `
                        : `
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-home-btn" class="text-sm text-gray-600 hover:underline">
                            ãƒ¦ãƒ¼ã‚¶ãƒ¼ãã‚Šã‹ãˆ
                        </button>
                        <button id="delete-card-btn" class="text-sm text-red-500 hover:underline">
                            ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‘ã™
                        </button>
                    </div>
                    `
                }
            </div>
        `;

        renderRewardSelector();
        renderBackgroundSelector();
        addSetupListeners();
    }

    function renderBackgroundSelector() {
        const state = getCurrentState();
        if (!state) return;
        const selector = document.getElementById('background-selector');
        if (!selector) return;
        const backgrounds = [
            { value: '#fff9e6', name: 'ãã„ã‚' },
            { value: '#e0f2fe', name: 'ã¿ãšã„ã‚' },
            { value: '#fce7f3', name: 'ã´ã‚“ã' },
            { value: '#f0fdf4', name: 'ã¿ã©ã‚Š' }
        ];
        selector.innerHTML = backgrounds.map(bg => {
            const isSelected = state.cardBackground === bg.value;
            return `
                <div data-bg="${bg.value}" class="cursor-pointer text-center">
                    <div class="w-12 h-12 rounded-full border-4 ${isSelected ? 'border-yellow-500 ring-2 ring-yellow-500' : 'border-white'}" style="background-color: ${bg.value};"></div>
                    <span class="text-xs font-semibold text-gray-600">${bg.name}</span>
                </div>
            `;
        }).join('');
    }
    
    function renderRewardSelector() {
        const state = getCurrentState();
        if (!state) return;
        const selector = document.getElementById('reward-selector');
        selector.innerHTML = '';
        const lastIndex = state.stampCount - 1;
        for (let i = 0; i < state.stampCount; i++) {
            const isReward = state.rewards.includes(i);
            const isLast = (i === lastIndex);
            const slot = document.createElement('div');
            let classes = 'aspect-square rounded-full flex justify-center items-center border-2 text-sm font-bold ';
            if (isLast) classes += 'bg-orange-400 border-orange-500 text-white cursor-not-allowed';
            else if (isReward) classes += 'bg-orange-400 border-orange-500 text-white cursor-pointer';
            else classes += 'bg-gray-100 border-gray-300 cursor-pointer';
            slot.className = classes;
            slot.dataset.index = i;
            slot.innerHTML = isReward ? 'ğŸ' : i + 1;
            selector.appendChild(slot);
        }
    }

    // ã‚«ãƒ¼ãƒ‰ç”»é¢
    function renderCard() {
        const state = getCurrentState();
        if (!state) return renderHomeScreen();
        state.isSetup = false;
        
        app.innerHTML = `
  <div id="capture-area"
       class="rounded-2xl p-4"
       style="background-color: ${state.cardBackground};">
    <div class="text-center pt-4 mb-4">
      <h1 class="text-2xl font-bold text-yellow-800">${state.name}ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰</h1>
      ${state.goal ? `<p class="text-lg font-semibold text-gray-600 mt-2">ã€Œ${state.goal}ã€</p>` : ''}
    </div>
    <div class="stamp-card"></div>

                <!-- ãƒ¡ãƒ¢ï¼†ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆç”»åƒã«ã‚‚å†™ã‚‹ï¼‰ -->
                <div class="px-4 pb-4 mt-4 space-y-3">
                  <div>
                    <label for="memo-input" class="block text-sm font-bold text-gray-700 mb-1">
                      ãƒ¡ãƒ¢
                    </label>
                    <textarea
                      id="memo-input"
                      class="w-full text-sm border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400 bg-white/80"
                      rows="2"
                      placeholder="ãã®æ—¥ã®ã‚ˆã†ã™ã‚„ã€ãŒã‚“ã°ã£ãŸãƒã‚¤ãƒ³ãƒˆã‚’ãƒ¡ãƒ¢ã§ãã¾ã™ã€‚"
                    >${state.memo || ''}</textarea>
                  </div>

                  <div>
                    <label for="comment-input" class="block text-sm font-bold text-gray-700 mb-1">
                      ${state.name || 'ãŠå­ã•ã‚“'}ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆ
                    </label>
                    <textarea
                      id="comment-input"
                      class="w-full text-sm border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-400 bg-white/80"
                      rows="2"
                      placeholder="ãŸã¨ãˆã°ã€Œâ—‹â—‹ã—ã¦ãã‚Œã¦åŠ©ã‹ã£ãŸã‚ˆã€ã€Œãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸã“ã¨ãŒã™ã”ã„ã­ã€ãªã©ã€ã»ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ãã¨åŠ¹æœã‚¢ãƒƒãƒ—ï¼"
                    >${state.comment || ''}</textarea>
                  </div>
                </div>
            </div>
            <div id="action-buttons-container"></div>
        `;
        
        const cardContainer = app.querySelector('.stamp-card');
        for (let i = 0; i < state.stampCount; i++) {
            const slot = document.createElement('div');
            slot.className = 'stamp-slot';
            slot.dataset.index = i;
            let content = `<span class="absolute text-gray-400 font-bold text-xl">${i + 1}</span>`;
            if (state.rewards.includes(i)) {
                slot.classList.add('is-reward');
                content += '<span class="reward-icon">ğŸ</span>';
            }
            
            const exchanged = state.exchanges.find(e => e.index === i);
            const stamped = state.stamps.find(s => s.index === i);
            
            if (exchanged) {
                content += `
                    <div class="exchanged-slot-content">
                        <svg class="exchanged-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                        <span class="exchanged-date">${exchanged.date}</span>
                    </div>
                `;
            } else if (stamped) {
                content += `<img src="${stamped.image}" class="stamp-image" alt="ã‚¹ã‚¿ãƒ³ãƒ—">`;
                content += `<span class="stamp-date">${stamped.date}</span>`;
            }

            slot.innerHTML = content;
            cardContainer.appendChild(slot);
        }

        const filledSlots = state.stamps.length + state.exchanges.length;
        const isComplete = filledSlots === state.stampCount && state.stampCount > 0;
        
        let actionHTML = '';
        if (isComplete) {
            actionHTML = `
                <div class="mt-6 flex justify-center">
                    <button id="action-btn" data-action="save" class="bg-green-500 text-white font-bold py-3 px-6 rounded-full hover:bg-green-600 transition shadow-lg">é ‘å¼µã‚Šã‚’å†™çœŸã§ç´ã‚ã‚‹</button>
                </div>
            `;
        } else {
            const exchangeBtnClass = isExchangeMode ? 'bg-red-500' : 'bg-purple-500';
            const exchangeBtnHover = isExchangeMode ? 'hover:bg-red-600' : 'hover:bg-purple-600';
            const exchangeBtnText = isExchangeMode ? 'äº¤æ›ã™ã‚‹ãƒã‚¹ã‚’é¸ã‚“ã§ã­ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«)' : 'ãƒã‚¤ãƒ³ãƒˆäº¤æ›';
            actionHTML = `
                <div class="mt-6 flex flex-col items-center gap-4">
                    <button id="exchange-btn" class="w-full max-w-xs text-sm ${exchangeBtnClass} text-white font-bold py-3 px-5 rounded-full ${exchangeBtnHover} transition">${exchangeBtnText}</button>
                    <div class="flex justify-center gap-4">
                        <button id="back-to-home-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-5 rounded-full hover:bg-gray-300 transition">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãã‚Šã‹ãˆ</button>
                        <button id="go-to-setup-btn" class="bg-yellow-200 text-yellow-800 font-bold py-2 px-5 rounded-full hover:bg-yellow-300 transition">
                            ä»Šã®ã‚«ãƒ¼ãƒ‰ã‚’ä¿®æ­£
                        </button>
                    </div>
                </div>
            `;
        }
        document.getElementById('action-buttons-container').innerHTML = actionHTML;

        addCardListeners();
    }
    
    function updateStockedStampsInModal() {
        const state = getCurrentState();
        if (!state) return;

        for (let i = 0; i < 3; i++) {
            const stockedStampDiv = document.getElementById(`stocked-stamp-${i}`);
            const deleteBtn = stockedStampDiv.querySelector('.stock-delete-btn');

            stockedStampDiv.querySelectorAll('img, span').forEach(el => el.remove());

            if (state.stockedStamps[i]) {
                const imgEl = document.createElement('img');
                imgEl.src = state.stockedStamps[i];
                imgEl.alt = 'ã‚¹ãƒˆãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—';
                imgEl.className = 'stamp-image';

                stockedStampDiv.appendChild(imgEl);
                stockedStampDiv.classList.remove('bg-gray-100');
                stockedStampDiv.classList.add('border-2', 'border-gray-300');

                stockedStampDiv.onclick = (e) => {
                    if (e.target.classList.contains('stock-delete-btn')) return;
                    applyStamp(state.stockedStamps[i]);
                };

                deleteBtn.classList.remove('hidden');
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    state.stockedStamps.splice(i, 1);
                    saveAppData();
                    updateStockedStampsInModal();
                };

            } else {
                const plusSpan = document.createElement('span');
                plusSpan.className = 'text-gray-400 text-lg';
                plusSpan.textContent = '+';
                stockedStampDiv.appendChild(plusSpan);

                stockedStampDiv.classList.add('bg-gray-100');
                stockedStampDiv.classList.remove('border-2', 'border-gray-300');

                deleteBtn.classList.add('hidden');
                deleteBtn.onclick = null;
                stockedStampDiv.onclick = null;
            }
        }
    }
    
    function addHomeScreenListeners() {
        const addNewCardBtn = document.getElementById('add-new-card-btn');

        if (addNewCardBtn) {
            addNewCardBtn.addEventListener('click', () => {
                const newUserState = {
                    name: '',
                    goal: '',
                    stampCount: 10,
                    rewards: [],
                    stamps: [],
                    exchanges: [],
                    isSetup: true,
                    stampingIndex: null,
                    stockedStamps: [],
                    cardBackground: '#fff9e6',
                    memo: '',
                    comment: ''
                };
                appData.users.push(newUserState);
                appData.currentUserIndex = appData.users.length - 1;
                saveAppData();
                renderSetup();
            });
        }

        document.querySelectorAll('.user-select-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index, 10);
                appData.currentUserIndex = index;

                const state = getCurrentState();
                if (!state) {
                    renderHomeScreen();
                    return;
                }

                if (state.isSetup || !state.name) {
                    renderSetup();
                } else {
                    renderCard();
                }
            });
        });

        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const index = parseInt(e.currentTarget.dataset.index, 10);
                deleteIndex = index;
                deleteMode = 'user';

                const userToDelete = appData.users[index];
                const name = userToDelete.name || `ã‚«ãƒ¼ãƒ‰ ${index + 1}`;

                const deleteModal = document.getElementById('delete-confirm-modal');
                const deleteTitle = document.getElementById('delete-confirm-title');
                deleteTitle.textContent = `ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
                deleteModal.classList.add('is-visible');
            });
        });
    }

    function addSetupListeners() {
        const state = getCurrentState();
        if (!state) return;

        const isEditMode = !state.isSetup;

        document.getElementById('name-input').addEventListener('input', (e) => {
            state.name = e.target.value;
        });

        document.getElementById('goal-input').addEventListener('input', (e) => {
            state.goal = e.target.value;
        });

        document.getElementById('stamp-count-slider').addEventListener('input', (e) => {
            const newCount = parseInt(e.target.value, 10);
            state.stampCount = newCount;
            document.getElementById('stamp-count-label').textContent = state.stampCount;

            state.rewards = state.rewards.filter(r => r < state.stampCount);
            const lastIndex = state.stampCount - 1;
            if (!state.rewards.includes(lastIndex)) state.rewards.push(lastIndex);
            renderRewardSelector();
        });

        document.getElementById('reward-selector').addEventListener('click', (e) => {
            const target = e.target.closest('div[data-index]');
            if (!target) return;

            const index = parseInt(target.dataset.index, 10);
            if (index === state.stampCount - 1) return;

            if (state.rewards.includes(index)) {
                state.rewards = state.rewards.filter(r => r !== index);
            } else {
                state.rewards.push(index);
            }
            renderRewardSelector();
        });

        document.getElementById('background-selector').addEventListener('click', (e) => {
            const target = e.target.closest('div[data-bg]');
            if (!target) return;
            state.cardBackground = target.dataset.bg;
            renderBackgroundSelector();
        });

        document.getElementById('create-card-btn').addEventListener('click', () => {
            if (!state.name) {
                alert('ãªã¾ãˆã‚’ã„ã‚Œã¦ã­ï¼');
                return;
            }

            if (!isEditMode) {
                state.stamps = [];
                state.exchanges = [];
                state.memo = '';
                state.comment = '';
            }

            state.isSetup = false;
            saveAppData();
            renderCard();
        });

        if (isEditMode) {
            const backToCardBtn = document.getElementById('back-to-card-btn');
            if (backToCardBtn) {
                backToCardBtn.addEventListener('click', () => {
                    if (editBackup) {
                        appData.users[appData.currentUserIndex] = editBackup;
                    }
                    saveAppData();
                    renderCard();
                });
            }
        } else {
            const backToHomeBtn = document.getElementById('back-to-home-btn');
            if (backToHomeBtn) {
                backToHomeBtn.addEventListener('click', renderHomeScreen);
            }
        }

        const deleteBtn = document.getElementById('delete-card-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                deleteIndex = appData.currentUserIndex;
                deleteMode = 'user';
                const currentName = state.name || `ã‚«ãƒ¼ãƒ‰ ${deleteIndex + 1}`;

                const deleteModal = document.getElementById('delete-confirm-modal');
                const deleteTitle = document.getElementById('delete-confirm-title');
                deleteTitle.textContent = `ã€Œ${currentName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
                deleteModal.classList.add('is-visible');
            });
        }
    }
    
    function addCardListeners() {
        const state = getCurrentState();
        if (!state) return;
        
        app.querySelector('.stamp-card').addEventListener('click', (e) => {
            const target = e.target.closest('.stamp-slot');
            if (!target) return;
            
            const targetIndex = parseInt(target.dataset.index, 10);
            const isStamped = state.stamps.some(s => s.index === targetIndex);
            const isExchanged = state.exchanges.some(e => e.index === targetIndex);

            if (isExchangeMode) {
                if (isExchanged) return; 
                applyExchange(targetIndex);
            } else {
                if (isStamped || isExchanged) return; 
                state.stampingIndex = targetIndex;
                updateStockedStampsInModal();
                stampModal.classList.add('is-visible');
            }
        });

        const backToHomeBtn = document.getElementById('back-to-home-btn');
        if (backToHomeBtn) backToHomeBtn.addEventListener('click', renderHomeScreen);
            
        const goToSetupBtn = document.getElementById('go-to-setup-btn');
        if (goToSetupBtn) goToSetupBtn.addEventListener('click', renderSetup);

        const actionBtn = document.getElementById('action-btn');
        if (actionBtn) actionBtn.addEventListener('click', handleCardCompletion);

        const exchangeBtn = document.getElementById('exchange-btn');
        if (exchangeBtn) {
            exchangeBtn.addEventListener('click', () => {
                isExchangeMode = !isExchangeMode;
                exchangeBtn.textContent = isExchangeMode ? 'äº¤æ›ã™ã‚‹ãƒã‚¹ã‚’é¸ã‚“ã§ã­ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«)' : 'ãƒã‚¤ãƒ³ãƒˆäº¤æ›';
                exchangeBtn.classList.toggle('bg-purple-500');
                exchangeBtn.classList.toggle('hover:bg-purple-600');
                exchangeBtn.classList.toggle('bg-red-500');
                exchangeBtn.classList.toggle('hover:bg-red-600');
            });
        }

        // ãƒ¡ãƒ¢ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›ã®ä¿å­˜
        const memoInput = document.getElementById('memo-input');
        const commentInput = document.getElementById('comment-input');

        if (memoInput) {
            memoInput.addEventListener('input', (e) => {
                state.memo = e.target.value;
                saveAppData();
            });
        }
        if (commentInput) {
            commentInput.addEventListener('input', (e) => {
                state.comment = e.target.value;
                saveAppData();
            });
        }

        // ã‚¹ã‚¿ãƒ³ãƒ—é•·æŠ¼ã—ã§å‰Šé™¤
        const slots = app.querySelectorAll('.stamp-slot');

        slots.forEach(slot => {
            let pressTimer = null;

            const startPress = (event) => {
                const idx = parseInt(slot.dataset.index, 10);
                const isStamped = state.stamps.some(s => s.index === idx);
                const isExchanged = state.exchanges.some(e => e.index === idx);

                if (!isStamped || isExchanged) return;

                pressTimer = setTimeout(() => {
                    deleteIndex = idx;
                    deleteMode = 'stamp';

                    const deleteModal = document.getElementById('delete-confirm-modal');
                    const deleteTitle = document.getElementById('delete-confirm-title');
                    deleteTitle.textContent = `${idx + 1}ã°ã‚“ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ`;
                    deleteModal.classList.add('is-visible');
                }, 600);
            };

            const cancelPress = () => {
                if (pressTimer !== null) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            };

            slot.addEventListener('mousedown', startPress);
            slot.addEventListener('mouseup', cancelPress);
            slot.addEventListener('mouseleave', cancelPress);

            slot.addEventListener('touchstart', startPress);
            slot.addEventListener('touchend', cancelPress);
            slot.addEventListener('touchcancel', cancelPress);
        });
    }

    function applyExchange(targetIndex) {
        const state = getCurrentState();
        if (!state) return;
        
        state.stamps = state.stamps.filter(s => s.index !== targetIndex);
        state.exchanges = state.exchanges.filter(e => e.index !== targetIndex);

        const now = new Date();
        const formattedDate = `${now.getMonth() + 1}/${now.getDate()}`;
        
        state.exchanges.push({ index: targetIndex, date: formattedDate });
        
        isExchangeMode = false;
        renderCard();
        saveAppData();

        if (state.rewards.includes(targetIndex)) {
            showCelebration();
        }
    }

    async function applyStamp(imageSrc) {
        const state = getCurrentState();
        if (!state || state.stampingIndex === null) return;
        const targetIndex = state.stampingIndex;
        
        animatedStampImage.src = imageSrc;
        stampOverlay.classList.add('is-visible');
        const targetSlot = app.querySelector(`.stamp-slot[data-index="${targetIndex}"]`);
        const rect = targetSlot.getBoundingClientRect();
        animatedStampImage.style.left = `${rect.left + rect.width / 2}px`;
        animatedStampImage.style.top = `${rect.top + rect.height / 2}px`;
        await new Promise(r => setTimeout(r, 50));
        animatedStampImage.classList.add('animate-in');
        await new Promise(r => setTimeout(r, 300));
        
        const now = new Date();
        const formattedDate = `${now.getMonth() + 1}/${now.getDate()}`;
        state.stamps.push({ index: targetIndex, image: imageSrc, date: formattedDate });
        state.stampingIndex = null;
        
        renderCard();
        
        animatedStampImage.classList.remove('animate-in');
        animatedStampImage.classList.add('animate-out');
        await new Promise(r => setTimeout(r, 300));
        stampOverlay.classList.remove('is-visible');

        if (state.rewards.includes(targetIndex)) showCelebration();
        saveAppData();
        stampModal.classList.remove('is-visible');
    }

    async function handleCardCompletion() {
        const state = getCurrentState();
        if (!state) return;
        const actionBtn = document.getElementById('action-btn');
        if (!actionBtn) return;
        
        const action = actionBtn.dataset.action;
        
        if (action === 'save') {
            const captureArea = document.getElementById('capture-area');
            try {
                document.body.style.overflow = 'hidden';
                window.scrollTo(0, 0);

                const canvas = await html2canvas(captureArea, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: state.cardBackground
                });
                
                const imageURL = canvas.toDataURL("image/png");
                const downloadLink = document.createElement('a');
                const fileName = `${state.name}_ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰_${new Date().toISOString().split('T')[0]}.png`;
                downloadLink.href = imageURL;
                downloadLink.download = fileName;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                document.body.style.overflow = 'auto';

                actionBtn.textContent = 'æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã«é€²ã‚€';
                actionBtn.dataset.action = 'next';
                actionBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                actionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');

            } catch (err) {
                console.error('ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                document.body.style.overflow = 'auto';
            }
            
        } else if (action === 'next') {
            state.stamps = [];
            state.exchanges = [];
            state.memo = '';
            state.comment = '';
            state.isSetup = true;
            saveAppData();
            renderSetup();
        }
    }
    
    function createStampSVG(type) {
        let svgContent = '';
        switch(type) {
            case 'star':
                svgContent =
                    '<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                    '<path fill="#FBBF24" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>' +
                    '</svg>';
                break;
            case 'heart':
                svgContent =
                    '<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                    '<path fill-rule="evenodd" fill="#60A5FA" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>' +
                    '</svg>';
                break;
            case 'thumb':
                svgContent =
                    '<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                    '<path fill="#4ADE80" d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a2 2 0 00-.8 1.4z"></path>' +
                    '</svg>';
                break;
        }
        return 'data:image/svg+xml;utf8,' + encodeURIComponent(svgContent);
    }

    function showCelebration() {
        const state = getCurrentState();
        if (!state) return;

        const messageEl = document.getElementById('celebration-message');
        messageEl.textContent = `${state.name}ã€ã”ã»ã†ã³ãŠã‚ã§ã¨ã†ï¼`;
        celebrationScreen.classList.add('is-visible');

        confettiInstance({
            particleCount: 120,
            spread: 80,
            origin: { y: 0.6 }
        });
    }

    function init() {
        const deleteModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.remove('is-visible');
            deleteIndex = null;
            deleteMode = null;
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteIndex === null) return;

            if (deleteMode === 'user') {
                appData.users.splice(deleteIndex, 1);
                appData.currentUserIndex = null;
                saveAppData();
                renderHomeScreen();
            } else if (deleteMode === 'stamp') {
                const state = getCurrentState();
                if (state) {
                    state.stamps = state.stamps.filter(s => s.index !== deleteIndex);
                    saveAppData();
                    renderCard();
                }
            }

            deleteModal.classList.remove('is-visible');
            deleteIndex = null;
            deleteMode = null;
        });

        document.getElementById('cancel-stamp').addEventListener('click', () => {
            stampModal.classList.remove('is-visible');
            const state = getCurrentState();
            if (state) state.stampingIndex = null;
        });

        document.getElementById('default-stamp-1').addEventListener('click', () => applyStamp(createStampSVG('star')));
        document.getElementById('default-stamp-2').addEventListener('click', () => applyStamp(createStampSVG('heart')));
        document.getElementById('default-stamp-3').addEventListener('click', () => applyStamp(createStampSVG('thumb')));
    
        document.getElementById('image-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const state = getCurrentState();
            if (!file || !state) {
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const maxSize = 300;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round(height * (maxSize / width));
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round(width * (maxSize / height));
                            height = maxSize;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const imageUrl = canvas.toDataURL('image/jpeg', 0.8);

                    if (state.stockedStamps.length >= 3) {
                        state.stockedStamps.shift();
                    }
                    state.stockedStamps.push(imageUrl);

                    saveAppData();
                    applyStamp(imageUrl);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);

            e.target.value = '';
        });

        document.getElementById('close-celebration').addEventListener('click', () => {
            celebrationScreen.classList.remove('is-visible');
        });

        loadAppData();
        if (appData.currentUserIndex !== null && appData.users[appData.currentUserIndex]) {
            const state = getCurrentState();
            if (state.isSetup || !state.name) {
                renderSetup();
            } else {
                renderCard();
            }
        } else {
            renderHomeScreen();
        }
    }

    init();
  });
  </script>

</body>
</html>
