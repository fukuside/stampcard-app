<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­è‚²ã¦ãŒã‚“ã°ã‚Šã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</title>
    
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PGKHZQSTRJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PGKHZQSTRJ');
</script>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- canvas-confettiã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- html2canvasã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* å…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'BIZ UDPGothic', Meiryo, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .stamp-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            padding: 16px;
            /* background-color ã¯JSã§å‹•çš„ã«è¨­å®š */
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stamp-slot {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
            border-radius: 50%;
            background-color: #ffffff;
            border: 3px dashed #fbd38d;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* ç”»åƒãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
        }
        .stamp-slot:hover {
            transform: scale(1.05);
        }

        .stamp-slot.is-reward .reward-icon {
            display: block;
        }
        
        .reward-icon {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #f6ad55;
            z-index: 5;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¦¨ã’ãªã„ã‚ˆã†ã« */
        }

        .stamp-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            z-index: 10;
        }
        
        .stamp-date {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: #6a4d0f; /* æ¿ƒã„ã‚ã®èŒ¶è‰² */
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 5px;
            border-radius: 8px;
            z-index: 15;
            white-space: nowrap;
        }

        /* ã‚¹ãƒˆãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—ç”¨ å‰Šé™¤ãƒœã‚¿ãƒ³ */
.stock-delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    border-radius: 9999px;
    border: none;
    background-color: rgba(0,0,0,0.5);
    color: #fff;
    font-size: 14px;
    line-height: 18px;
    text-align: center;
    cursor: pointer;
    z-index: 20;
}


        /* äº¤æ›æ¸ˆã¿ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .exchanged-slot-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 50%;
            background-color: #e5e7eb; /* ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
        }
        .exchanged-icon {
            font-size: 1.5rem; /* 24px */
            color: #16a34a; /* æ¿ƒã„ç·‘ */
        }
        .exchanged-date {
            font-size: 0.75rem; /* 12px */
            color: #4b5563; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
            font-weight: 600;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.is-visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.is-visible .modal-content {
             transform: scale(1);
        }
        
        /* é”æˆæ™‚ã®ãŠç¥ã„ç”»é¢ç”¨ */
        #celebration-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: rgba(255, 250, 230, 0.9);
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
        }
        #celebration-screen.is-visible {
            opacity: 1;
            visibility: visible;
        }
        #celebration-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ– */
        }

        /* ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        .stamp-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šæ‰‹å‰ */
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’é€šéã•ã›ã‚‹ */
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        .stamp-overlay.is-visible {
            opacity: 1;
        }
        .animated-stamp {
            position: absolute;
            width: 80px; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚µã‚¤ã‚º */
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            transform: scale(2); /* åˆæœŸã¯å¤§ãã‚ */
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .animated-stamp.animate-in {
            transform: scale(1) translateY(-20px); /* è»½ãæµ®ãä¸ŠãŒã‚‹ã‚ˆã†ã« */
            opacity: 1;
        }
        .animated-stamp.animate-out {
            transform: scale(0.5); /* å°ã•ãæ¶ˆãˆã‚‹ */
            opacity: 0;
        }
    </style>
</head>
<body class="bg-amber-50">

    <div id="app" class="p-4 max-w-lg mx-auto">
        <!-- ã‚¢ãƒ—ãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«æç”»ã•ã‚Œã¾ã™ -->
    </div>

    <!-- å³ä¸‹ã®ç¤¾åï¼‹ãƒ­ã‚´ -->
<div class="fixed bottom-4 right-4 flex items-center gap-2 text-xs md:text-sm bg-white/80 rounded-full shadow px-3 py-1">
  <img
    src="fukushi-logo.png"
    alt="ä¸€èˆ¬ç¤¾å›£æ³•äººç¦ç¥‰ã§ã¤ãªãŒã‚‹ä¼š ãƒ­ã‚´"
    class="w-6 h-6 rounded-full object-contain"
  >
  <span class="text-gray-600 font-semibold">
    ä¸€èˆ¬ç¤¾å›£æ³•äººç¦ç¥‰ã§ã¤ãªãŒã‚‹ä¼š
  </span>
</div>


    <!-- ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="stamp-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-center mb-4 text-gray-700">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãˆã‚‰ã‚“ã§ã­</h3>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ãƒ³ãƒ— -->
                <div id="default-stamp-1" class="p-2 bg-yellow-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-yellow-200 transition">
                    <svg class="w-10 h-10 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                </div>
                <div id="default-stamp-2" class="p-2 bg-blue-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-blue-200 transition">
                    <svg class="w-10 h-10 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                </div>
                <div id="default-stamp-3" class="p-2 bg-green-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-green-200 transition">
                    <svg class="w-10 h-10 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a2 2 0 00-.8 1.4z"></path></svg>
                </div>
                
                <!-- ã‚¹ãƒˆãƒƒã‚¯ã•ã‚ŒãŸãƒ”ã‚¯ãƒãƒ£ãƒ¼ã‚¹ã‚¿ãƒ³ãƒ— -->
<div id="stocked-stamp-0" class="relative p-2 bg-gray-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-gray-200 transition">
    <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆç”»åƒãŒã‚ã‚‹ã¨ãã ã‘åŠ¹ãï¼‰ -->
    <button class="stock-delete-btn hidden" type="button">Ã—</button>
    <span class="text-gray-400 text-lg"></span>
</div>
<div id="stocked-stamp-1" class="relative p-2 bg-gray-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-gray-200 transition">
    <button class="stock-delete-btn hidden" type="button">Ã—</button>
    <span class="text-gray-400 text-lg"></span>
</div>
<div id="stocked-stamp-2" class="relative p-2 bg-gray-100 rounded-full aspect-square flex justify-center items-center cursor-pointer hover:bg-gray-200 transition">
    <button class="stock-delete-btn hidden" type="button">Ã—</button>
    <span class="text-gray-400 text-lg"></span>
</div>
            </div>
            <label for="image-upload" class="w-full text-center block bg-orange-400 text-white font-bold py-3 px-4 rounded-lg cursor-pointer hover:bg-orange-500 transition">
                ã—ã‚ƒã—ã‚“ã‹ã‚‰ãˆã‚‰ã¶
            </label>
            <input type="file" id="image-upload" class="hidden" accept="image/*">
            <button id="cancel-stamp" class="w-full text-center mt-3 text-gray-600 py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
    
    <!-- ã”è¤’ç¾é”æˆãŠç¥ã„ç”»é¢ -->
    <div id="celebration-screen">
        <canvas id="celebration-canvas"></canvas>
        <div class="text-center p-4 relative z-10">
            <p class="text-4xl font-bold text-orange-500 mb-2" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">ã‚„ã£ãŸã­ï¼</p>
            <p id="celebration-message" class="text-xl font-semibold text-gray-700"></p>
            <button id="close-celebration" class="mt-8 bg-white text-orange-500 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-orange-50 transition">ã¨ã˜ã‚‹</button>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="stamp-overlay" class="stamp-overlay">
        <img id="animated-stamp-image" src="" alt="ã‚¹ã‚¿ãƒ³ãƒ—" class="animated-stamp">
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="delete-confirm-modal" class="modal-backdrop">
        <div class="modal-content text-center">
            <h3 id="delete-confirm-title" class="text-xl font-bold text-center mb-4 text-gray-700"></h3>
            <p class="text-gray-600 mb-6">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-delete-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const app = document.getElementById('app');
    const stampModal = document.getElementById('stamp-modal');
    const celebrationScreen = document.getElementById('celebration-screen');
    const celebrationCanvas = document.getElementById('celebration-canvas');
    const stampOverlay = document.getElementById('stamp-overlay');
    const animatedStampImage = document.getElementById('animated-stamp-image');
    let confettiInstance = confetti.create(celebrationCanvas, { resize: true });

    // ã‚¢ãƒ—ãƒªå…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    let appData = {
        currentUserIndex: null,
        users: []
    };
    let deleteIndex = null;      // å‰Šé™¤å¯¾è±¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ or ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒã‚¹ç•ªå·ï¼‰
    let deleteMode = null;       // 'user' or 'stamp' ã‚’å…¥ã‚Œã‚‹
    let isExchangeMode = false;  // äº¤æ›ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹
    // â˜… è¿½åŠ ï¼šä¿®æ­£å‰ã®çŠ¶æ…‹ã‚’ã¨ã£ã¦ãŠãå ´æ‰€
    let editBackup = null;
    
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    const getCurrentState = () => {
        if (appData.currentUserIndex === null || !appData.users[appData.currentUserIndex]) {
            return null;
        }
        return appData.users[appData.currentUserIndex];
    };

    // --- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– ---
    function saveAppData() {
        localStorage.setItem('ganbariCardAppData', JSON.stringify(appData));
    }

    function loadAppData() {
        const savedData = localStorage.getItem('ganbariCardAppData');
        if (savedData) {
            appData = JSON.parse(savedData);

            appData.users.forEach(user => {
                if (typeof user.cardBackground === 'undefined') {
                    user.cardBackground = '#fff9e6'; 
                }
                if (typeof user.exchanges === 'undefined') {
                    user.exchanges = [];
                }
                if (!Array.isArray(user.stockedStamps)) {
                    user.stockedStamps = [];
                }

                // â˜… ã“ã“ã§å¤ã„ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£
                if (Array.isArray(user.stamps)) {
                    user.stamps.forEach(s => {
                        if (!s || typeof s.image !== 'string') return;
                        const trimmed = s.image.trim();
                        if (trimmed.startsWith('<img')) {
                            const m = trimmed.match(/src="([^"]+)"/);
                            if (m) {
                                s.image = m[1]; // src ã®ä¸­èº«ã ã‘ã‚’ä¿å­˜ã—ç›´ã™
                            }
                        }
                    });
                }
            });
            return;
        }

        // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ã®ç§»è¡Œ
        const oldSavedState = localStorage.getItem('ganbariCardState');
        if(oldSavedState){
            const oldState = JSON.parse(oldSavedState);
            if (oldState.name || (oldState.stamps && oldState.stamps.length > 0)) {
                oldState.goal = oldState.goal || '';
                oldState.cardBackground = '#fff9e6';
                oldState.exchanges = [];
                oldState.stockedStamps = oldState.stockedStamps || [];
                // æ—§å½¢å¼ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚ã“ã“ã§ä¿®æ­£
                if (Array.isArray(oldState.stamps)) {
                    oldState.stamps.forEach(s => {
                        if (!s || typeof s.image !== 'string') return;
                        const trimmed = s.image.trim();
                        if (trimmed.startsWith('<img')) {
                            const m = trimmed.match(/src="([^"]+)"/);
                            if (m) {
                                s.image = m[1];
                            }
                        }
                    });
                }
                appData.users.push(oldState);
                appData.currentUserIndex = 0;
            }
            localStorage.removeItem('ganbariCardState');
            saveAppData();
        }
    }

    // --- æç”»é–¢æ•° ---

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠç”»é¢ã®æç”»
function renderHomeScreen() {
    // äº¤æ›ãƒ¢ãƒ¼ãƒ‰ã¯å¿…ãšOFFã«ã—ã¦ãŠã
    isExchangeMode = false;
    // ã©ã®ã‚«ãƒ¼ãƒ‰ã‚‚é¸ã‚“ã§ã„ãªã„çŠ¶æ…‹ã«ã™ã‚‹
    appData.currentUserIndex = null;

    const users = appData.users || [];

    // å„ã‚«ãƒ¼ãƒ‰ã®è¡Œï¼ˆãƒœã‚¿ãƒ³ï¼‰ã‚’ä½œæˆ
    const userButtons = users.map((user, index) => {
        const name = user.name || `ã‚«ãƒ¼ãƒ‰ ${index + 1}`;

        // äº¤æ›ã‚‚ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸€éƒ¨ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
        const filledSlots = (user.stamps?.length || 0) + (user.exchanges?.length || 0);
        const total = user.stampCount || 0;
        const isComplete = total > 0 && filledSlots === total;
        const progressLabel = total > 0 ? `${filledSlots}/${total}` : '0/10';

        return `
            <div class="flex items-center mb-3">
                <button
                    data-index="${index}"
                    class="user-select-btn w-full text-left p-4 bg-white rounded-lg shadow hover:bg-yellow-50 transition flex justify-between items-center">
                    <span class="text-lg font-bold text-gray-700">${name}</span>
                    <span class="text-sm font-semibold ${isComplete ? 'text-green-500' : 'text-gray-500'}">
                        ${isComplete ? 'ã‹ã‚“ã›ã„ï¼' : progressLabel}
                    </span>
                </button>
                <button
                    data-index="${index}"
                    class="delete-user-btn ml-2 p-3 bg-red-100 rounded-full hover:bg-red-200 transition">
                    <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                              d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                              clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        `;
    }).join('');

    // ã€Œã‚ãŸã‚‰ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆæœ€å¤§5æšã¾ã§ï¼‰
    const newCardButton = users.length < 5
        ? `
        <button
            id="add-new-card-btn"
            class="w-full mt-4 p-4 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition shadow-lg">
            ã‚ãŸã‚‰ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹
        </button>
        `
        : '';

    app.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-center mb-4 text-yellow-600">
                ã©ã®ã‚«ãƒ¼ãƒ‰ã‚’ã¤ã‹ã„ã¾ã™ã‹ï¼Ÿ
            </h1>
            <div class="user-list mt-4">
                ${userButtons || ''}
            </div>
            ${newCardButton}
        </div>
    `;

    addHomeScreenListeners();
}
    
 // è¨­å®šç”»é¢ã®æç”»
function renderSetup() {
    isExchangeMode = false;
    const state = getCurrentState();
    if (!state) return renderHomeScreen();

    // isSetup === trueâ€¦ã¾ã ã‚«ãƒ¼ãƒ‰ã‚’ä½œã£ã¦ã„ã‚‹é€”ä¸­ï¼ˆæ–°è¦ï¼‰
    // isSetup === falseâ€¦ã™ã§ã«ã‚«ãƒ¼ãƒ‰ç”»é¢ãŒã‚ã‚‹ï¼ˆï¼ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ï¼‰
    const isEditMode = !state.isSetup;

    // â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ãŸç¬é–“ã®çŠ¶æ…‹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    if (isEditMode) {
        editBackup = JSON.parse(JSON.stringify(state));
    } else {
        editBackup = null;
    }

    // ã”ã»ã†ã³ä½ç½®ã‚’æ•´ç†
    state.rewards = state.rewards.filter(r => r < state.stampCount);
    const lastIndex = state.stampCount - 1;
    if (!state.rewards.includes(lastIndex)) state.rewards.push(lastIndex);

    const minStampCount = isEditMode ? state.stampCount : 5;
    const primaryBtnLabel = isEditMode ? 'ã‚«ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹' : 'ã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹ï¼';
    const titleText = isEditMode ? 'ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã‚ˆã†' : 'ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚ã†';

    app.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-center mb-1 text-yellow-600">${titleText}</h1>
            <p class="text-center text-gray-500 mb-6">ãªã¾ãˆã‚„ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‹ãšã‚’ãã‚ã¦ã­</p>

            <div class="mb-4">
                <label for="name-input" class="block text-gray-700 font-bold mb-2">ãªã¾ãˆ</label>
                <input
                    type="text"
                    id="name-input"
                    value="${state.name}"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                    placeholder="ï¼ˆã‚Œã„ï¼‰ãŸã‚ã†">
            </div>

            <div class="mb-4">
                <label for="goal-input" class="block text-gray-700 font-bold mb-2">ã‚‚ãã²ã‚‡ã†</label>
                <input
                    type="text"
                    id="goal-input"
                    value="${state.goal || ''}"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                    placeholder="ï¼ˆã‚Œã„ï¼‰æœï¼—æ™‚ã¾ã§ã«ãŠãã¾ã™">
            </div>

            <div class="mb-6">
                <p class="block text-gray-700 font-bold mb-2">ã‚«ãƒ¼ãƒ‰ã® ã¯ã„ã‘ã„</p>
                <div id="background-selector" class="flex gap-3 justify-center"></div>
            </div>

            <div class="mb-6">
                <label for="stamp-count-slider" class="block text-gray-700 font-bold mb-2">
                    ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‹ãš: <span id="stamp-count-label">${state.stampCount}</span>
                </label>
                <input
                    type="range"
                    id="stamp-count-slider"
                    min="${minStampCount}"
                    max="30"
                    value="${state.stampCount}"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                ${
                    isEditMode
                        ? '<p class="mt-1 text-xs text-gray-500">â€» ã„ã¾ã‚ˆã‚Šå°‘ãªãã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“</p>'
                        : ''
                }
            </div>

            <div class="mb-6">
                <p class="block text-gray-700 font-bold mb-2">ã”ã»ã†ã³ã‚’ã„ã‚Œã‚‹</p>
                <div id="reward-selector" class="grid grid-cols-5 gap-2"></div>
            </div>

            <button
                id="create-card-btn"
                class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition">
                ${primaryBtnLabel}
            </button>

            ${
                isEditMode
                    ? `
                <div class="mt-6 flex justify-between">
                    <button id="back-to-card-btn" class="text-sm text-gray-600 hover:underline">
                        ä¿®æ­£ã‚’ã—ãªã„ã§ã‚‚ã©ã‚‹
                    </button>
                    <button id="delete-card-btn" class="text-sm text-red-500 hover:underline">
                        ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‘ã™
                    </button>
                </div>
                `
                    : `
                <div class="mt-6 flex justify-between">
                    <button id="back-to-home-btn" class="text-sm text-gray-600 hover:underline">
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãã‚Šã‹ãˆ
                    </button>
                    <button id="delete-card-btn" class="text-sm text-red-500 hover:underline">
                        ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‘ã™
                    </button>
                </div>
                `
            }
        </div>
    `;

    renderRewardSelector();
    renderBackgroundSelector();
    addSetupListeners();
}

    // èƒŒæ™¯è‰²é¸æŠã®æç”»
    function renderBackgroundSelector() {
        const state = getCurrentState();
        if (!state) return;
        const selector = document.getElementById('background-selector');
        if (!selector) return;
        const backgrounds = [
            { value: '#fff9e6', name: 'ãã„ã‚' },
            { value: '#e0f2fe', name: 'ã¿ãšã„ã‚' },
            { value: '#fce7f3', name: 'ã´ã‚“ã' },
            { value: '#f0fdf4', name: 'ã¿ã©ã‚Š' }
        ];
        selector.innerHTML = backgrounds.map(bg => {
            const isSelected = state.cardBackground === bg.value;
            return `
                <div data-bg="${bg.value}" class="cursor-pointer text-center">
                    <div class="w-12 h-12 rounded-full border-4 ${isSelected ? 'border-yellow-500 ring-2 ring-yellow-500' : 'border-white'}" style="background-color: ${bg.value};"></div>
                    <span class="text-xs font-semibold text-gray-600">${bg.name}</span>
                </div>
            `;
        }).join('');
    }
    
    // ã”ã»ã†ã³è¨­å®šãƒã‚¹ã®æç”»
    function renderRewardSelector() {
        const state = getCurrentState();
        if (!state) return;
        const selector = document.getElementById('reward-selector');
        selector.innerHTML = '';
        const lastIndex = state.stampCount - 1;
        for (let i = 0; i < state.stampCount; i++) {
            const isReward = state.rewards.includes(i);
            const isLast = (i === lastIndex);
            const slot = document.createElement('div');
            let classes = 'aspect-square rounded-full flex justify-center items-center border-2 text-sm font-bold ';
            if (isLast) classes += 'bg-orange-400 border-orange-500 text-white cursor-not-allowed';
            else if (isReward) classes += 'bg-orange-400 border-orange-500 text-white cursor-pointer';
            else classes += 'bg-gray-100 border-gray-300 cursor-pointer';
            slot.className = classes;
            slot.dataset.index = i;
            slot.innerHTML = isReward ? 'ğŸ' : i + 1;
            selector.appendChild(slot);
        }
    }

    // ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ç”»é¢ã®æç”»
    function renderCard() {
        const state = getCurrentState();
        if (!state) return renderHomeScreen();
        state.isSetup = false;
        
        app.innerHTML = `
            <div id="capture-area" style="background-color: ${state.cardBackground}; border-radius: 16px;">
                <div class="text-center pt-4 mb-4">
                    <h1 class="text-2xl font-bold text-yellow-800">${state.name}ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰</h1>
                    ${state.goal ? `<p class="text-lg font-semibold text-gray-600 mt-2">ã€Œ${state.goal}ã€</p>` : ''}
                </div>
                <div class="stamp-card" style="background-color: ${state.cardBackground};"></div>
            </div>
            <div id="action-buttons-container"></div>
        `;
        
        const cardContainer = app.querySelector('.stamp-card');
        for (let i = 0; i < state.stampCount; i++) {
            const slot = document.createElement('div');
            slot.className = 'stamp-slot';
            slot.dataset.index = i;
            let content = `<span class="absolute text-gray-400 font-bold text-xl">${i + 1}</span>`;
            if (state.rewards.includes(i)) {
                slot.classList.add('is-reward');
                content += '<span class="reward-icon">ğŸ</span>';
            }
            
            const exchanged = state.exchanges.find(e => e.index === i);
            const stamped = state.stamps.find(s => s.index === i);
            
            if (exchanged) {
                // äº¤æ›æ¸ˆã¿ã®è¡¨ç¤º
                content += `
                    <div class="exchanged-slot-content">
                        <svg class="exchanged-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                        <span class="exchanged-date">${exchanged.date}</span>
                    </div>
                `;
            } else if (stamped) {
                // ã‚¹ã‚¿ãƒ³ãƒ—æ¸ˆã¿ã®è¡¨ç¤º
                content += `<img src="${stamped.image}" class="stamp-image" alt="ã‚¹ã‚¿ãƒ³ãƒ—">`;
                content += `<span class="stamp-date">${stamped.date}</span>`;
            }
            // ã©ã¡ã‚‰ã§ã‚‚ãªã‘ã‚Œã°ã€ç©ºã®ãƒã‚¹(æ•°å­—ã¨ã”è¤’ç¾ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿)

            slot.innerHTML = content;
            cardContainer.appendChild(slot);
        }

        const filledSlots = state.stamps.length + state.exchanges.length;
        const isComplete = filledSlots === state.stampCount && state.stampCount > 0;
        
        let actionHTML = '';
        if (isComplete) {
            actionHTML = `
                <div class="mt-6 flex justify-center">
                    <button id="action-btn" data-action="save" class="bg-green-500 text-white font-bold py-3 px-6 rounded-full hover:bg-green-600 transition shadow-lg">é ‘å¼µã‚Šã‚’å†™çœŸã§ç´ã‚ã‚‹</button>
                </div>
            `;
        } else {
            const exchangeBtnClass = isExchangeMode ? 'bg-red-500' : 'bg-purple-500';
            const exchangeBtnHover = isExchangeMode ? 'hover:bg-red-600' : 'hover:bg-purple-600';
            const exchangeBtnText = isExchangeMode ? 'äº¤æ›ã™ã‚‹ãƒã‚¹ã‚’é¸ã‚“ã§ã­ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«)' : 'ãƒã‚¤ãƒ³ãƒˆäº¤æ›';
            actionHTML = `
                <div class="mt-6 flex flex-col items-center gap-4">
                    <button id="exchange-btn" class="w-full max-w-xs text-sm ${exchangeBtnClass} text-white font-bold py-3 px-5 rounded-full ${exchangeBtnHover} transition">${exchangeBtnText}</button>
                    <div class="flex justify-center gap-4">
                        <button id="back-to-home-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-5 rounded-full hover:bg-gray-300 transition">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãã‚Šã‹ãˆ</button>
                        <button id="go-to-setup-btn" class="bg-yellow-200 text-yellow-800 font-bold py-2 px-5 rounded-full hover:bg-yellow-300 transition">
  ä»Šã®ã‚«ãƒ¼ãƒ‰ã‚’ä¿®æ­£
</button>
                    </div>
                </div>
            `;
        }
        document.getElementById('action-buttons-container').innerHTML = actionHTML;

        addCardListeners();
    }
    
    // ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ãƒˆãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°
function updateStockedStampsInModal() {
    const state = getCurrentState();
    if (!state) return;

    for (let i = 0; i < 3; i++) {
        const stockedStampDiv = document.getElementById(`stocked-stamp-${i}`);
        const deleteBtn = stockedStampDiv.querySelector('.stock-delete-btn');

        // ã„ã£ãŸã‚“ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆÃ—ãƒœã‚¿ãƒ³ã ã‘æ®‹ã™ï¼‰
        stockedStampDiv.querySelectorAll('img, span').forEach(el => el.remove());

        if (state.stockedStamps[i]) {
            // ç”»åƒã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚‹ã¨ã
            const imgEl = document.createElement('img');
            imgEl.src = state.stockedStamps[i];
            imgEl.alt = 'ã‚¹ãƒˆãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—';
            imgEl.className = 'stamp-image';

            stockedStampDiv.appendChild(imgEl);
            stockedStampDiv.classList.remove('bg-gray-100');
            stockedStampDiv.classList.add('border-2', 'border-gray-300');

            // ã‚¯ãƒªãƒƒã‚¯ã§ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã—ã¦ä½¿ã†
            stockedStampDiv.onclick = (e) => {
                // Ã—ã‚’æŠ¼ã—ãŸã¨ãã¯ã‚¹ã‚¿ãƒ³ãƒ—å‡¦ç†ã‚’èµ°ã‚‰ã›ãªã„
                if (e.target.classList.contains('stock-delete-btn')) return;
                applyStamp(state.stockedStamps[i]);
            };

            // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            deleteBtn.classList.remove('hidden');
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // è¦ªã®ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—æŠ¼ã—ï¼‰ã‚’ç„¡åŠ¹åŒ–
                // iç•ªç›®ã®ã‚¹ãƒˆãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
                state.stockedStamps.splice(i, 1);
                saveAppData();
                updateStockedStampsInModal();
            };

        } else {
            // ç©ºã®ã‚¹ãƒ­ãƒƒãƒˆï¼ˆï¼‹è¡¨ç¤ºï¼‰
            const plusSpan = document.createElement('span');
            plusSpan.className = 'text-gray-400 text-lg';
            plusSpan.textContent = '+';
            stockedStampDiv.appendChild(plusSpan);

            stockedStampDiv.classList.add('bg-gray-100');
            stockedStampDiv.classList.remove('border-2', 'border-gray-300');

            // ç”»åƒãŒãªã„ã¨ãã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éš ã™
            deleteBtn.classList.add('hidden');
            deleteBtn.onclick = null;

            // ç©ºã‚¹ãƒ­ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ä½•ã‚‚ã—ãªã„
            stockedStampDiv.onclick = null;
        }
    }
}

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    
   function addHomeScreenListeners() {
    const addNewCardBtn = document.getElementById('add-new-card-btn');

    // ã€Œã‚ãŸã‚‰ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹ã€
    if (addNewCardBtn) {
        addNewCardBtn.addEventListener('click', () => {
            const newUserState = {
                name: '',
                goal: '',
                stampCount: 10,
                rewards: [],
                stamps: [],
                exchanges: [],
                isSetup: true,      // â˜… æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã¯ã€Œè¨­å®šç”»é¢ã‹ã‚‰ã€ã‚¹ã‚¿ãƒ¼ãƒˆ
                stampingIndex: null,
                stockedStamps: [],
                cardBackground: '#fff9e6'
            };
            appData.users.push(newUserState);
            appData.currentUserIndex = appData.users.length - 1;
            saveAppData();
            renderSetup();
        });
    }

    // æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
    document.querySelectorAll('.user-select-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.currentTarget.dataset.index, 10);
            appData.currentUserIndex = index;

            const state = getCurrentState();
            if (!state) {
                renderHomeScreen();
                return;
            }

            // åå‰ãŒã¾ã ãªã‚‰è¨­å®šç”»é¢ã‹ã‚‰
            if (state.isSetup || !state.name) {
                renderSetup();
            } else {
                renderCard();
            }
        });
    });

    // ã‚«ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼‰
    document.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(e.currentTarget.dataset.index, 10);
            deleteIndex = index;
            deleteMode = 'user';

            const userToDelete = appData.users[index];
            const name = userToDelete.name || `ã‚«ãƒ¼ãƒ‰ ${index + 1}`;

            const deleteModal = document.getElementById('delete-confirm-modal');
            const deleteTitle = document.getElementById('delete-confirm-title');
            deleteTitle.textContent = `ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            deleteModal.classList.add('is-visible');
        });
    });
}

   function addSetupListeners() {
    const state = getCurrentState();
    if (!state) return;

    const isEditMode = !state.isSetup;

    // å…¥åŠ›å€¤ã®åæ˜ 
    document.getElementById('name-input').addEventListener('input', (e) => {
        state.name = e.target.value;
    });

    document.getElementById('goal-input').addEventListener('input', (e) => {
        state.goal = e.target.value;
    });

    document.getElementById('stamp-count-slider').addEventListener('input', (e) => {
        const newCount = parseInt(e.target.value, 10);
        state.stampCount = newCount;
        document.getElementById('stamp-count-label').textContent = state.stampCount;

        state.rewards = state.rewards.filter(r => r < state.stampCount);
        const lastIndex = state.stampCount - 1;
        if (!state.rewards.includes(lastIndex)) state.rewards.push(lastIndex);
        renderRewardSelector();
    });

    document.getElementById('reward-selector').addEventListener('click', (e) => {
        const target = e.target.closest('div[data-index]');
        if (!target) return;

        const index = parseInt(target.dataset.index, 10);
        if (index === state.stampCount - 1) return; // æœ€å¾Œã®ãƒã‚¹ã¯å›ºå®šã§ã”ã»ã†ã³

        if (state.rewards.includes(index)) {
            state.rewards = state.rewards.filter(r => r !== index);
        } else {
            state.rewards.push(index);
        }
        renderRewardSelector();
    });

    document.getElementById('background-selector').addEventListener('click', (e) => {
        const target = e.target.closest('div[data-bg]');
        if (!target) return;
        state.cardBackground = target.dataset.bg;
        renderBackgroundSelector();
    });

    // ã€Œã‚«ãƒ¼ãƒ‰ã‚’ã¤ãã‚‹ï¼ã€ or ã€Œã‚«ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹ã€
    document.getElementById('create-card-btn').addEventListener('click', () => {
        if (!state.name) {
            alert('ãªã¾ãˆã‚’ã„ã‚Œã¦ã­ï¼');
            return;
        }

        // æ–°è¦ä½œæˆã®ã¨ãã ã‘ã‚¹ã‚¿ãƒ³ãƒ—å±¥æ­´ãƒªã‚»ãƒƒãƒˆ
        if (!isEditMode) {
            state.stamps = [];
            state.exchanges = [];
        }

        state.isSetup = false;
        saveAppData();
        renderCard();
    });

    // æˆ»ã‚‹ç³»ãƒœã‚¿ãƒ³
    if (isEditMode) {
        // ã€Œä¿®æ­£ã‚’ã—ãªã„ã§ã‚‚ã©ã‚‹ã€ï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§å…ƒã«æˆ»ã™
        const backToCardBtn = document.getElementById('back-to-card-btn');
        if (backToCardBtn) {
            backToCardBtn.addEventListener('click', () => {
                if (editBackup) {
                    appData.users[appData.currentUserIndex] = editBackup;
                }
                saveAppData();
                renderCard();
            });
        }
    } else {
        // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãã‚Šã‹ãˆã€
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', renderHomeScreen);
        }
    }

    // ã‚«ãƒ¼ãƒ‰å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆå…±é€šï¼‰
    const deleteBtn = document.getElementById('delete-card-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
            deleteIndex = appData.currentUserIndex;
            deleteMode = 'user';
            const currentName = state.name || `ã‚«ãƒ¼ãƒ‰ ${deleteIndex + 1}`;

            const deleteModal = document.getElementById('delete-confirm-modal');
            const deleteTitle = document.getElementById('delete-confirm-title');
            deleteTitle.textContent = `ã€Œ${currentName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            deleteModal.classList.add('is-visible');
        });
    }
}
    
   function addCardListeners() {
    const state = getCurrentState();
    if (!state) return;
    
    // â–¼ æ—¢å­˜ï¼šã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã™å‡¦ç†
    app.querySelector('.stamp-card').addEventListener('click', (e) => {
        const target = e.target.closest('.stamp-slot');
        if (!target) return;
        
        const targetIndex = parseInt(target.dataset.index, 10);
        const isStamped = state.stamps.some(s => s.index === targetIndex);
        const isExchanged = state.exchanges.some(e => e.index === targetIndex);

        if (isExchangeMode) {
            if (isExchanged) return; 
            applyExchange(targetIndex);
        } else {
            if (isStamped || isExchanged) return; 
            state.stampingIndex = targetIndex;
            updateStockedStampsInModal();
            stampModal.classList.add('is-visible');
        }
    });

    // â–¼ æ—¢å­˜ï¼šãƒœã‚¿ãƒ³é¡ã®ãƒªã‚¹ãƒŠãƒ¼
    const backToHomeBtn = document.getElementById('back-to-home-btn');
    if (backToHomeBtn) backToHomeBtn.addEventListener('click', renderHomeScreen);
        
    const goToSetupBtn = document.getElementById('go-to-setup-btn');
    if (goToSetupBtn) goToSetupBtn.addEventListener('click', renderSetup);

    const actionBtn = document.getElementById('action-btn');
    if (actionBtn) actionBtn.addEventListener('click', handleCardCompletion);

    const exchangeBtn = document.getElementById('exchange-btn');
    if (exchangeBtn) {
        exchangeBtn.addEventListener('click', () => {
            isExchangeMode = !isExchangeMode;
            exchangeBtn.textContent = isExchangeMode ? 'äº¤æ›ã™ã‚‹ãƒã‚¹ã‚’é¸ã‚“ã§ã­ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«)' : 'ãƒã‚¤ãƒ³ãƒˆäº¤æ›';
            exchangeBtn.classList.toggle('bg-purple-500');
            exchangeBtn.classList.toggle('hover:bg-purple-600');
            exchangeBtn.classList.toggle('bg-red-500');
            exchangeBtn.classList.toggle('hover:bg-red-600');
        });
    }

    // â˜… ã“ã“ã‹ã‚‰è¿½åŠ ï¼šã‚¹ã‚¿ãƒ³ãƒ—é•·æŠ¼ã—ã§å‰Šé™¤
    const slots = app.querySelectorAll('.stamp-slot');

    slots.forEach(slot => {
        let pressTimer = null;

        const startPress = (event) => {
            const idx = parseInt(slot.dataset.index, 10);
            const isStamped = state.stamps.some(s => s.index === idx);
            const isExchanged = state.exchanges.some(e => e.index === idx);

            // ã‚¹ã‚¿ãƒ³ãƒ—ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹ãƒã‚¹ã ã‘é•·æŠ¼ã—å‰Šé™¤ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            if (!isStamped || isExchanged) return;

            // 600ms é•·æŠ¼ã—ã§ç™ºç«
            pressTimer = setTimeout(() => {
                deleteIndex = idx;
                deleteMode = 'stamp';

                const deleteModal = document.getElementById('delete-confirm-modal');
                const deleteTitle = document.getElementById('delete-confirm-title');
                deleteTitle.textContent = `${idx + 1}ã°ã‚“ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ`;
                deleteModal.classList.add('is-visible');
            }, 600);
        };

        const cancelPress = () => {
            if (pressTimer !== null) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        };

        // PCç”¨
        slot.addEventListener('mousedown', startPress);
        slot.addEventListener('mouseup', cancelPress);
        slot.addEventListener('mouseleave', cancelPress);

        // ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨
        slot.addEventListener('touchstart', startPress);
        slot.addEventListener('touchend', cancelPress);
        slot.addEventListener('touchcancel', cancelPress);
    });
    // â˜… è¿½åŠ ã“ã“ã¾ã§
}


    // ãƒã‚¤ãƒ³ãƒˆäº¤æ›ã‚’é©ç”¨ã™ã‚‹å‡¦ç†
    function applyExchange(targetIndex) {
        const state = getCurrentState();
        if (!state) return;
        
        state.stamps = state.stamps.filter(s => s.index !== targetIndex);
        state.exchanges = state.exchanges.filter(e => e.index !== targetIndex);

        const now = new Date();
        const formattedDate = `${now.getMonth() + 1}/${now.getDate()}`;
        
        state.exchanges.push({ index: targetIndex, date: formattedDate });
        
        isExchangeMode = false;
        renderCard();
        saveAppData();

        if (state.rewards.includes(targetIndex)) {
            showCelebration();
        }
    }

    // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã™å‡¦ç†
    async function applyStamp(imageSrc) {
        const state = getCurrentState();
        if (!state || state.stampingIndex === null) return;
        const targetIndex = state.stampingIndex;
        
        animatedStampImage.src = imageSrc;
        stampOverlay.classList.add('is-visible');
        const targetSlot = app.querySelector(`.stamp-slot[data-index="${targetIndex}"]`);
        const rect = targetSlot.getBoundingClientRect();
        animatedStampImage.style.left = `${rect.left + rect.width / 2}px`;
        animatedStampImage.style.top = `${rect.top + rect.height / 2}px`;
        await new Promise(r => setTimeout(r, 50));
        animatedStampImage.classList.add('animate-in');
        await new Promise(r => setTimeout(r, 300));
        
        const now = new Date();
        const formattedDate = `${now.getMonth() + 1}/${now.getDate()}`;
        state.stamps.push({ index: targetIndex, image: imageSrc, date: formattedDate });
        state.stampingIndex = null;
        
        renderCard();
        
        animatedStampImage.classList.remove('animate-in');
        animatedStampImage.classList.add('animate-out');
        await new Promise(r => setTimeout(r, 300));
        stampOverlay.classList.remove('is-visible');

        if (state.rewards.includes(targetIndex)) showCelebration();
        saveAppData();
        stampModal.classList.remove('is-visible');
    }

    // ã‚«ãƒ¼ãƒ‰å®Œæˆæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    async function handleCardCompletion() {
        const state = getCurrentState();
        if (!state) return;
        const actionBtn = document.getElementById('action-btn');
        if (!actionBtn) return;
        
        const action = actionBtn.dataset.action;
        
        if (action === 'save') {
            const captureArea = document.getElementById('capture-area');
            try {
                document.body.style.overflow = 'hidden';
                window.scrollTo(0, 0);

                const canvas = await html2canvas(captureArea, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: state.cardBackground
                });
                
                const imageURL = canvas.toDataURL("image/png");
                const downloadLink = document.createElement('a');
                const fileName = `${state.name}_ãŒã‚“ã°ã‚Šã‚«ãƒ¼ãƒ‰_${new Date().toISOString().split('T')[0]}.png`;
                downloadLink.href = imageURL;
                downloadLink.download = fileName;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                document.body.style.overflow = 'auto';

                actionBtn.textContent = 'æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã«é€²ã‚€';
                actionBtn.dataset.action = 'next';
                actionBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                actionBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');

            } catch (err) {
                console.error('ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                console.log('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                document.body.style.overflow = 'auto';
            }
            
        } else if (action === 'next') {
            state.stamps = [];
            state.exchanges = [];
            state.isSetup = true;
            saveAppData();
            renderSetup();
        }
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ãƒ³ãƒ—SVGã‚’ç”Ÿæˆï¼ˆâ˜…ä¿®æ­£ç‰ˆï¼‰
    function createStampSVG(type) {
        let svgContent = '';
        switch(type) {
            case 'star':
                svgContent =
                    '<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                    '<path fill="#FBBF24" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>' +
                    '</svg>';
                break;
            case 'heart':
                svgContent =
                    '<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                    '<path fill-rule="evenodd" fill="#60A5FA" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>' +
                    '</svg>';
                break;
            case 'thumb':
                svgContent =
                    '<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">' +
                    '<path fill="#4ADE80" d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a2 2 0 00-.8 1.4z"></path>' +
                    '</svg>';
                break;
        }
        // SVG ã‚’é©åˆ‡ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ dataURL ã«ã™ã‚‹
        return 'data:image/svg+xml;utf8,' + encodeURIComponent(svgContent);
    }

    // ãŠç¥ã„è¡¨ç¤º
    function showCelebration() {
        const state = getCurrentState();
        if (!state) return;

        const messageEl = document.getElementById('celebration-message');
        messageEl.textContent = `${state.name}ã€ã”ã»ã†ã³ãŠã‚ã§ã¨ã†ï¼`;
        celebrationScreen.classList.add('is-visible');

        confettiInstance({
            particleCount: 120,
            spread: 80,
            origin: { y: 0.6 }
        });
    }

    // --- åˆæœŸåŒ–å‡¦ç† ---
    function init() {
        const deleteModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

       cancelDeleteBtn.addEventListener('click', () => {
    deleteModal.classList.remove('is-visible');
    deleteIndex = null;
    deleteMode = null; // â˜… è¿½åŠ 
});

        confirmDeleteBtn.addEventListener('click', () => {
    if (deleteIndex === null) return;

    if (deleteMode === 'user') {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰å‰Šé™¤
        appData.users.splice(deleteIndex, 1);
        appData.currentUserIndex = null;
        saveAppData();
        renderHomeScreen();
    } else if (deleteMode === 'stamp') {
        // ã‚¹ã‚¿ãƒ³ãƒ—å‰Šé™¤
        const state = getCurrentState();
        if (state) {
            // å¯¾è±¡ãƒã‚¹ã®ã‚¹ã‚¿ãƒ³ãƒ—ã ã‘æ¶ˆã™
            state.stamps = state.stamps.filter(s => s.index !== deleteIndex);
            saveAppData();
            renderCard();
        }
    }

    const deleteModal = document.getElementById('delete-confirm-modal');
    deleteModal.classList.remove('is-visible');
    deleteIndex = null;
    deleteMode = null;
});

        // ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('cancel-stamp').addEventListener('click', () => {
            stampModal.classList.remove('is-visible');
            const state = getCurrentState();
            if (state) state.stampingIndex = null;
        });

        document.getElementById('default-stamp-1').addEventListener('click', () => applyStamp(createStampSVG('star')));
        document.getElementById('default-stamp-2').addEventListener('click', () => applyStamp(createStampSVG('heart')));
        document.getElementById('default-stamp-3').addEventListener('click', () => applyStamp(createStampSVG('thumb')));
    
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('image-upload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const state = getCurrentState();
    if (!file || !state) {
        e.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
            // æœ€å¤§ã‚µã‚¤ã‚ºï¼ˆé•·ã„è¾ºï¼‰ã‚’ 300px ã«åˆ¶é™
            const maxSize = 300;
            let width = img.width;
            let height = img.height;

            if (width > height) {
                if (width > maxSize) {
                    height = Math.round(height * (maxSize / width));
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width = Math.round(width * (maxSize / height));
                    height = maxSize;
                }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // JPEG å½¢å¼ãƒ»ç”»è³ª 0.8 ã§è»½é‡åŒ–
            const imageUrl = canvas.toDataURL('image/jpeg', 0.8);

            // ã‚¹ãƒˆãƒƒã‚¯ã‚¹ã‚¿ãƒ³ãƒ—ã«è¿½åŠ ï¼ˆæœ€å¤§3ã¤ï¼‰
            if (state.stockedStamps.length >= 3) {
                state.stockedStamps.shift();
            }
            state.stockedStamps.push(imageUrl);

            saveAppData();
            applyStamp(imageUrl);
        };
        img.src = event.target.result;
    };
    reader.readAsDataURL(file);

    // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¶šã‘ã¦é¸ã¹ã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
    e.target.value = '';
});

        // ãŠç¥ã„ç”»é¢ã‚’é–‰ã˜ã‚‹ãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('close-celebration').addEventListener('click', () => {
            celebrationScreen.classList.remove('is-visible');
        });

        loadAppData();
        if (appData.currentUserIndex !== null && appData.users[appData.currentUserIndex]) {
            const state = getCurrentState();
            if (state.isSetup || !state.name) {
                renderSetup();
            } else {
                renderCard();
            }
        } else {
            renderHomeScreen();
        }
    }

    init();
});
</script>

</body>
</html>
